root /var/www/html;
index index.php index.html;

autoindex off;

add_header Vary Accept always;
add_header X-Frame-Options SAMEORIGIN always;
add_header X-Content-Type-Options nosniff always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Access-Control-Allow-Origin *;
add_header Access-Control-Allow-Methods "GET, OPTIONS,POST, PUT,PATCH, DELETE";
add_header Access-Control-Allow-Headers "Content-Type, Authorization";
add_header Access-Control-Expose-Headers "Origin";
add_header Access-Control-Max-Age "3600";
add_header Access-Control-Allow-Credentials "true";
add_header 'Access-Control-Expose-Headers' 'Link';

add_header Content-Security-Policy "default-src * data: 'unsafe-eval' 'unsafe-inline'" always;

location = /favicon.ico {
    log_not_found off;
    access_log off;
}

location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
}

location = /xmlrpc.php {
    return 403;
    access_log off;
    log_not_found off;
}

location ~* ^/(ip|server-status|status|info|env)$ {
    return 403;
    access_log off;
    log_not_found off;
}

# Cache skip conditions (variable setup)
set $skip_cache 0;

if ($request_method = POST) {
    set $skip_cache 1;
}
if ($query_string != "") {
    set $skip_cache 1;
}
if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|^/feed/*|/tag/.*/feed/*|index.php|/.*sitemap.*\.(xml|xsl)") {
    set $skip_cache 1;
}
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
    set $skip_cache 1;
}

location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ /\.ht {
    deny all;
}

location ~* \.(?:css|js)$ {
    gzip_static on;

    expires 1w;
    add_header Cache-Control "public, max-age=604800";
}

location ~* \.(?:jpg|jpeg|gif|png|webp|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc|woff|woff2)$ {
    gzip_static on;
    expires 1w;
    add_header Cache-Control "public, max-age=604800";
    access_log off;
    log_not_found off;
}

# Default location handler
location / {
    try_files $uri $uri/ /index.php?$args;
}

# PHP-FPM handling
location ~ [^/]\\.php(/|$) {
    # PHP-FPM handling
    fastcgi_split_path_info ^(.+\\.php)(/.+)$;
    try_files $uri =404;

    # fastcgi_cache mycache;
    # fastcgi_cache_valid 200 301 302 60m;
    # fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;
    # fastcgi_cache_methods GET HEAD;
    # fastcgi_cache_min_uses 1;
    # fastcgi_cache_lock on;

    # Header tambahan untuk debugging cache status
    # add_header X-Fastcgi-Cache $upstream_cache_status always;
    # add_header X-Cache $upstream_cache_status always;

    # Bypass dan no_cache untuk kondisi tertentu (misal login, POST, cookie)
    # fastcgi_cache_bypass $skip_cache;
    # fastcgi_no_cache $skip_cache;

    # Timeout untuk FastCGI communication
    fastcgi_send_timeout 300;
    fastcgi_read_timeout 300;
    fastcgi_connect_timeout 60s;

    fastcgi_intercept_errors on;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 4 256k;
    fastcgi_busy_buffers_size 256k;

    fastcgi_pass php_socket;
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
}

# Open file cache settings
# open_file_cache          max=2000 inactive=20s;
# open_file_cache_valid    60s;
# open_file_cache_min_uses 5;
# open_file_cache_errors   off;
